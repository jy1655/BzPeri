name: Build and Publish APT Repo

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*.*.*'
  release:
    types: [published]

# Security: Only allow releases from authorized users
# Note: Tag protection rules should be configured in repository settings

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: true

jobs:
  build:
    name: Build packages (${{ matrix.arch }})
    strategy:
      matrix:
        include:
          - arch: amd64
            runner: ubuntu-latest
            deb_arch: amd64
            use_container: true
          - arch: arm64
            runner: [self-hosted, Linux, ARM64]
            deb_arch: arm64
            use_container: true
    runs-on: ${{ matrix.runner }}
    container: ${{ matrix.use_container && 'debian:bookworm' || null }}
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          if [ "${{ matrix.use_container }}" = "true" ]; then
            # Inside container (already root)
            apt-get update
            apt-get install -y --no-install-recommends \
              build-essential cmake pkg-config debhelper \
              dpkg-dev apt-utils gnupg apt-transport-https ca-certificates \
              libglib2.0-dev libbluetooth-dev bluez bluez-tools git
          else
            # On self-hosted runner (need sudo)
            sudo apt-get update
            sudo apt-get install -y --no-install-recommends \
              build-essential cmake pkg-config debhelper \
              dpkg-dev apt-utils gnupg apt-transport-https \
              libglib2.0-dev libbluetooth-dev bluez bluez-tools
          fi

      - name: Determine version from tag or release
        id: get_version
        run: |
          VERSION=""
          if [ "${GITHUB_REF_TYPE}" = "tag" ]; then
            VERSION="${GITHUB_REF_NAME}"
          elif [ -n "${{ github.event.release.tag_name }}" ]; then
            VERSION="${{ github.event.release.tag_name }}"
          fi
          VERSION="${VERSION#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Build Debian packages
        env:
          BZPERI_VERSION: ${{ steps.get_version.outputs.version }}
        run: |
          chmod +x scripts/build-deb.sh
          ./scripts/build-deb.sh --cpack --version "$BZPERI_VERSION" --arch "${{ matrix.deb_arch }}"

      - name: Install lintian and check package quality
        run: |
          if [ "${{ matrix.use_container }}" = "true" ]; then
            apt-get install -y lintian
          else
            sudo apt-get install -y lintian
          fi
          echo "::group::Lintian Package Quality Check"
          for deb in packages/*.deb; do
            if [ -f "$deb" ]; then
              echo "Checking $(basename "$deb")..."
              # Run lintian with informational level, but don't fail on warnings
              lintian --info --display-info --color=auto "$deb" || true
              echo "---"
            fi
          done
          echo "::endgroup::"

      - name: Prepare APT repo fragment
        run: |
          ARCH=${{ matrix.deb_arch }}
          REPO_DIR=public-${ARCH}/repo
          mkdir -p "$REPO_DIR/pool/main"
          mkdir -p "$REPO_DIR/dists/stable/main/binary-${ARCH}"
          cp packages/*.deb "$REPO_DIR/pool/main/"
          pushd "$REPO_DIR" >/dev/null
          dpkg-scanpackages pool/main /dev/null | gzip -9c > dists/stable/main/binary-${ARCH}/Packages.gz
          dpkg-scanpackages pool/main /dev/null > dists/stable/main/binary-${ARCH}/Packages
          popd >/dev/null

      - name: Upload APT fragment artifact
        uses: actions/upload-artifact@v4
        with:
          name: apt-repo-${{ matrix.arch }}
          path: public-${{ matrix.deb_arch }}

  publish:
    name: Sign and publish APT repo
    needs: build
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - name: Download amd64 repo fragment
        uses: actions/download-artifact@v4
        with:
          name: apt-repo-amd64
          path: merge/amd64

      - name: Download arm64 repo fragment
        uses: actions/download-artifact@v4
        with:
          name: apt-repo-arm64
          path: merge/arm64

      - name: Merge fragments
        id: merge
        run: |
          mkdir -p public/repo/pool/main
          mkdir -p public/repo/dists/stable/main

          # Copy packages from each architecture
          for ARCH in amd64 arm64; do
            if [ -d "merge/$ARCH/repo/pool/main" ]; then
              echo "Processing $ARCH packages..."
              mkdir -p "public/repo/pool/main/$ARCH"
              cp -r "merge/$ARCH/repo/pool/main/." "public/repo/pool/main/$ARCH/"
            else
              echo "Warning: No packages found for $ARCH"
            fi
          done

          # Generate Packages files for each architecture
          ARCHS=""
          for ARCH in amd64 arm64; do
            if [ -d "public/repo/pool/main/$ARCH" ] && [ "$(ls -A "public/repo/pool/main/$ARCH" 2>/dev/null)" ]; then
              echo "Generating Packages for $ARCH..."
              mkdir -p "public/repo/dists/stable/main/binary-$ARCH"

              cd public/repo
              dpkg-scanpackages "pool/main/$ARCH" /dev/null | gzip -9c > "dists/stable/main/binary-$ARCH/Packages.gz"
              dpkg-scanpackages "pool/main/$ARCH" /dev/null > "dists/stable/main/binary-$ARCH/Packages"
              cd - >/dev/null

              ARCHS="$ARCHS $ARCH"
            else
              echo "No packages found for $ARCH, skipping..."
            fi
          done
          ARCHS=$(echo "$ARCHS" | xargs)
          echo "architectures=$ARCHS" >> $GITHUB_OUTPUT

      - name: Determine version from tag or release
        id: get_version
        run: |
          VERSION=""
          if [ "${GITHUB_REF_TYPE}" = "tag" ]; then
            VERSION="${GITHUB_REF_NAME}"
          elif [ -n "${{ github.event.release.tag_name }}" ]; then
            VERSION="${{ github.event.release.tag_name }}"
          fi
          VERSION="${VERSION#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Create Release file
        env:
          ARCHS: ${{ steps.merge.outputs.architectures }}
          PKG_VERSION: ${{ steps.get_version.outputs.version }}
        run: |
          # Ensure stable directory exists
          mkdir -p public/repo/dists/stable
          pushd public/repo/dists/stable >/dev/null

          # Create Release file header
          cat > Release << EOF
          Origin: BzPeri Repository
          Label: BzPeri
          Suite: stable
          Codename: stable
          Version: ${PKG_VERSION:-1.0}
          Architectures: ${ARCHS:-amd64}
          Components: main
          Description: BzPeri APT repository
          Date: $(date -u '+%a, %d %b %Y %H:%M:%S UTC')
          EOF

          # Generate checksums for all files
          apt-ftparchive release . >> Release
          popd >/dev/null

      - name: Import GPG private key and sign repository
        env:
          APT_GPG_PRIVATE_KEY: ${{ secrets.APT_GPG_PRIVATE_KEY }}
          APT_GPG_PASSPHRASE: ${{ secrets.APT_GPG_PASSPHRASE }}
        run: |
          if [ -n "$APT_GPG_PRIVATE_KEY" ]; then
            echo "GPG private key found, signing repository..."

            # Configure GPG for non-interactive operation
            export GPG_TTY=$(tty)
            mkdir -p ~/.gnupg
            chmod 700 ~/.gnupg
            echo "pinentry-mode loopback" >> ~/.gnupg/gpg.conf
            echo "use-agent" >> ~/.gnupg/gpg.conf
            echo "batch" >> ~/.gnupg/gpg.conf

            # Import GPG key with proper passphrase handling
            if [ -n "$APT_GPG_PASSPHRASE" ]; then
              echo "Importing key with passphrase..."
              echo "$APT_GPG_PRIVATE_KEY" | gpg --batch --yes --pinentry-mode loopback --passphrase "$APT_GPG_PASSPHRASE" --import
            else
              echo "Importing key without passphrase..."
              echo "$APT_GPG_PRIVATE_KEY" | gpg --batch --yes --import
            fi

            # List imported keys for debugging
            gpg --list-secret-keys --keyid-format=long

            # Get key ID
            KEYID=$(gpg --list-secret-keys --keyid-format=long | awk '/sec/{print $2}' | sed 's|.*/||' | head -1)
            echo "Using GPG key: $KEYID"

            # Test key usability
            echo "Testing key usability..."
            echo "test" | gpg --batch --yes --pinentry-mode loopback ${APT_GPG_PASSPHRASE:+--passphrase "$APT_GPG_PASSPHRASE"} \
                --local-user "$KEYID" --clearsign > /dev/null

            # Sign Release file
            pushd public/repo/dists/stable >/dev/null

            echo "Creating detached signature..."
            gpg --batch --yes --pinentry-mode loopback ${APT_GPG_PASSPHRASE:+--passphrase "$APT_GPG_PASSPHRASE"} \
                --local-user "$KEYID" --detach-sign --armor -o Release.gpg Release

            echo "Creating inline signature..."
            gpg --batch --yes --pinentry-mode loopback ${APT_GPG_PASSPHRASE:+--passphrase "$APT_GPG_PASSPHRASE"} \
                --local-user "$KEYID" --clearsign -o InRelease Release

            popd >/dev/null

            # Export public key (both filenames for compatibility)
            gpg --armor --export "$KEYID" > public/repo/repo.key
            gpg --armor --export "$KEYID" > public/repo/public.gpg

            # Verify signatures
            echo "Verifying signatures..."
            gpg --verify public/repo/dists/stable/Release.gpg public/repo/dists/stable/Release
            gpg --verify public/repo/dists/stable/InRelease

            echo "‚úÖ Repository signed and verified successfully"
          else
            echo "No GPG private key found, skipping repository signing"
            echo "Repository will be unsigned (not recommended for production)"
          fi

      - name: Add repo index page
        run: |
          mkdir -p public/repo
          cat > public/repo/index.html << 'EOF'
          <!doctype html>
          <html lang="en">
          <meta charset="utf-8">
          <meta name="viewport" content="width=device-width, initial-scale=1">
          <title>BzPeri APT Repository</title>
          <style>body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;max-width:820px;margin:40px auto;padding:0 16px;line-height:1.5}code{background:#f5f5f5;padding:0 4px;border-radius:4px}</style>
          <h1>BzPeri APT Repository</h1>
          <p>Supported Architectures: <strong>${{ steps.merge.outputs.architectures }}</strong></p>
          <h2>Setup</h2>
          <ol>
            <li>Install key:<br>
              <code>curl -fsSL https://jy1655.github.io/BzPeri/repo/repo.key | sudo gpg --dearmor -o /usr/share/keyrings/bzperi-archive-keyring.gpg</code>
            </li>
            <li>Add source:<br>
              <code>echo "deb [signed-by=/usr/share/keyrings/bzperi-archive-keyring.gpg] https://jy1655.github.io/BzPeri/repo stable main" | sudo tee /etc/apt/sources.list.d/bzperi.list</code>
            </li>
            <li>Install:<br>
              <code>sudo apt update && sudo apt install bzperi bzperi-dev bzperi-tools</code>
            </li>
            <li>Enable BlueZ experimental mode (required):<br>
              <code>sudo /usr/share/bzperi/configure-bluez-experimental.sh enable</code><br>
              <small>Tip: You can also auto-enable during install with <code>export BZPERI_AUTO_EXPERIMENTAL=1</code> then <code>sudo -E apt install bzperi</code>.</small>
            </li>
          </ol>
          <h2>Files</h2>
          <ul>
            <li><a href="/BzPeri/repo/repo.key">repo.key</a> / <a href="/BzPeri/repo/public.gpg">public.gpg</a></li>
            <li><a href="/BzPeri/repo/dists/stable/Release">Release</a> (<a href="/BzPeri/repo/dists/stable/InRelease">InRelease</a>, <a href="/BzPeri/repo/dists/stable/Release.gpg">Release.gpg</a>)</li>
            <li><a href="/BzPeri/repo/dists/stable/main/binary-amd64/Packages.gz">Packages.gz</a></li>
          </ul>
          </html>
          EOF

      - name: Create index.html for Pages
        env:
          PKG_VERSION: ${{ steps.get_version.outputs.version }}
          ARCHS: ${{ steps.merge.outputs.architectures }}
        run: |
          cat > public/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>BzPeri APT Repository</title>
            <style>
              body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; line-height: 1.6; }
              .header { text-align: center; margin-bottom: 40px; }
              .version { color: #666; font-size: 0.9em; }
              .code-block { background: #f5f5f5; padding: 15px; border-radius: 5px; overflow-x: auto; }
              .architecture { background: #e3f2fd; padding: 2px 8px; border-radius: 3px; font-size: 0.85em; margin: 0 2px; }
              .step { margin: 20px 0; padding: 15px; border-left: 4px solid #2196f3; background: #f8f9fa; }
              .warning { border-left-color: #ff9800; background: #fff8e1; }
              a { color: #1976d2; text-decoration: none; }
              a:hover { text-decoration: underline; }
            </style>
          </head>
          <body>
            <div class="header">
              <h1>üöÄ BzPeri APT Repository</h1>
              <p>Modern C++20 Bluetooth LE GATT Server Library</p>
              <p class="version">Version: ENV_PKG_VERSION | Architecture: ENV_ARCHS</p>
            </div>

            <div class="step">
              <h2>üì¶ Quick Installation</h2>
              <div class="code-block">
          # Add BzPeri repository<br>
          curl -fsSL https://jy1655.github.io/BzPeri/repo/repo.key | sudo gpg --dearmor -o /usr/share/keyrings/bzperi-archive-keyring.gpg<br>
          echo "deb [arch=amd64 signed-by=/usr/share/keyrings/bzperi-archive-keyring.gpg] https://jy1655.github.io/BzPeri/repo stable main" | sudo tee /etc/apt/sources.list.d/bzperi.list<br><br>

          # Install packages<br>
          sudo apt update<br>
          sudo apt install bzperi bzperi-dev bzperi-tools
              </div>
            </div>

            <div class="step warning">
              <h2>‚öôÔ∏è BlueZ Configuration (Recommended)</h2>
              <div class="code-block">
          # Auto-configure during installation<br>
          export BZPERI_AUTO_EXPERIMENTAL=1<br>
          sudo -E apt install bzperi<br><br>

          # Or configure manually after installation<br>
          sudo /usr/share/bzperi/configure-bluez-experimental.sh enable
              </div>
            </div>

            <div class="step">
              <h2>üèÉ Quick Start</h2>
              <div class="code-block">
          # Run example server (requires sudo for BlueZ access)<br>
          sudo bzp-standalone -d<br><br>

          # List available Bluetooth adapters<br>
          sudo bzp-standalone --list-adapters
              </div>
            </div>

            <div class="step">
              <h2>üìö Available Packages</h2>
              <ul>
                <li><strong>bzperi</strong> - Runtime library for applications</li>
                <li><strong>bzperi-dev</strong> - Development headers and pkg-config files</li>
                <li><strong>bzperi-tools</strong> - Command-line tools (bzp-standalone)</li>
              </ul>
              <p><strong>Supported Architectures:</strong> amd64 (x86_64), arm64 (aarch64)</p>
            </div>

            <div class="step">
              <h2>üîó Links</h2>
              <ul>
                <li><a href="https://github.com/jy1655/BzPeri">GitHub Repository</a></li>
                <li><a href="https://github.com/jy1655/BzPeri/blob/main/README.md">Documentation</a></li>
                <li><a href="https://github.com/jy1655/BzPeri/issues">Issues & Support</a></li>
                <li><a href="repo/">Browse Repository</a></li>
              </ul>
            </div>
          </body>
          </html>
          EOF

          # Replace environment variables
          sed -i "s/ENV_PKG_VERSION/${PKG_VERSION:-latest}/g" public/index.html
          sed -i "s/ENV_ARCHS/${ARCHS:-amd64}/g" public/index.html

      - name: Disable Jekyll for APT repo
        run: |
          # Prevent GitHub Pages (Jekyll) from interfering with APT files like Release.gpg/InRelease
          touch public/.nojekyll

      - name: Validate APT repository structure
        run: |
          echo "=== APT Repository Validation ==="

          # Check critical APT files exist
          REQUIRED_FILES=(
            "public/repo/dists/stable/Release"
          )

          # Add architecture-specific files based on what was built
          ARCHS="${{ steps.merge.outputs.architectures }}"
          for ARCH in $ARCHS; do
            REQUIRED_FILES+=(
              "public/repo/dists/stable/main/binary-$ARCH/Packages"
              "public/repo/dists/stable/main/binary-$ARCH/Packages.gz"
            )
          done

          MISSING_FILES=()
          for file in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              MISSING_FILES+=("$file")
            fi
          done

          if [ ${#MISSING_FILES[@]} -ne 0 ]; then
            echo "‚ùå Missing critical APT files:"
            printf '  %s\n' "${MISSING_FILES[@]}"
            exit 1
          fi

          # Check if packages exist
          PKG_COUNT=$(find public/repo/pool/main -name "*.deb" 2>/dev/null | wc -l)
          if [ "$PKG_COUNT" -eq 0 ]; then
            echo "‚ùå No .deb packages found in pool/main"
            exit 1
          fi

          # Check signing status
          if [ -f "public/repo/dists/stable/InRelease" ] && [ -f "public/repo/repo.key" ]; then
            echo "‚úÖ Repository is GPG signed"
            GPG_SIGNED=true
          else
            echo "‚ö†Ô∏è  Repository is unsigned (development mode)"
            GPG_SIGNED=false
          fi

          echo "‚úÖ Found $PKG_COUNT packages"
          echo "‚úÖ All critical APT files present"

          # Show repository structure
          echo ""
          echo "Repository structure:"
          find public/repo -type f | sort | sed 's/^/  /'

          # Validate Release file content
          echo ""
          echo "Release file validation:"
          ARCHS="${{ steps.merge.outputs.architectures }}"
          echo "Expected architectures: $ARCHS"

          for ARCH in $ARCHS; do
            if grep -q "Architectures:.*$ARCH" public/repo/dists/stable/Release; then
              echo "‚úÖ $ARCH architecture declared"
            else
              echo "‚ùå $ARCH architecture missing in Release"
              exit 1
            fi
          done

          if grep -q "Components:.*main" public/repo/dists/stable/Release; then
            echo "‚úÖ main component declared"
          else
            echo "‚ùå main component missing in Release"
            exit 1
          fi

          # Display final setup instructions
          echo ""
          echo "=== Installation Instructions ==="
          ARCHS="${{ steps.merge.outputs.architectures }}"

          if [ "$GPG_SIGNED" = true ]; then
            echo "Signed repository (recommended):"
            echo "  curl -fsSL https://jy1655.github.io/BzPeri/repo/repo.key | sudo gpg --dearmor -o /usr/share/keyrings/bzperi-archive-keyring.gpg"
            echo "  echo \"deb [signed-by=/usr/share/keyrings/bzperi-archive-keyring.gpg] https://jy1655.github.io/BzPeri/repo stable main\" | sudo tee /etc/apt/sources.list.d/bzperi.list"
          else
            echo "Unsigned repository (development only):"
            echo "  echo \"deb [trusted=yes] https://jy1655.github.io/BzPeri/repo stable main\" | sudo tee /etc/apt/sources.list.d/bzperi.list"
          fi
          echo "  sudo apt update && sudo apt install bzperi bzperi-dev bzperi-tools"
          echo ""
          echo "Supported architectures: $ARCHS"

      - name: Configure Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
